# =========================
# üåê Nginx optimis√© avec assets statiques
# =========================
# Cette image copie les assets depuis l'image Laravel d√©j√† build√©e
# pour √©viter le probl√®me de persistence des volumes Docker
ARG GITHUB_REPOSITORY=fredchess/onenation_oneheart
ARG IMAGE_TAG=latest
FROM ghcr.io/${GITHUB_REPOSITORY}:${IMAGE_TAG} AS assets

# Image finale Nginx ultra-l√©g√®re
FROM nginx:stable-alpine

# Copier la configuration Nginx personnalis√©e
COPY ./docker/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf

# Cr√©er le r√©pertoire pour les fichiers Laravel
RUN mkdir -p /var/www/public

# Copier UNIQUEMENT le dossier public depuis l'image Laravel
# Cela inclut les assets build√©s (/var/www/public/build)
COPY --from=assets /var/www/public /var/www/public

# Cr√©er le lien symbolique storage (√©quivalent de php artisan storage:link)
# Ce lien pointe vers /var/www/storage/app/public qui sera mont√© via volume partag√©
RUN ln -sfn /var/www/storage/app/public /var/www/public/storage

# Ajuster les permissions
# Note: On garde les fichiers PHP car Nginx doit pouvoir les lire
# pour les passer √† php-fpm (ils ne sont pas ex√©cut√©s par Nginx)
RUN chown -R nginx:nginx /var/www/public

# Pas d'exposition de port (g√©r√© par Traefik dans Dokploy)
CMD ["nginx", "-g", "daemon off;"]